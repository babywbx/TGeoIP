# Workflow By wbx
name: Update TGeoIP All Data

# Defines the triggers for this workflow.
on:
  # Triggers the workflow on a schedule (daily at midnight UTC).
  schedule:
    - cron: '0 0 * * *'

  # Also allow manual runs from the Actions tab.
  workflow_dispatch:

concurrency:
  group: update-geoip-all
  cancel-in-progress: true

# Grant write permissions to the GITHUB_TOKEN for pushing commit results.
permissions:
  contents: write

# Define the main job for this workflow.
jobs:
  update-geoip-all:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # Step 1: Check out the repository's code to the runner.
      - name: Checkout main branch
        uses: actions/checkout@v6

      # Step 2: Download the MMDB database required by the application.
      - name: Download IPinfo MMDB Database
        run: |
          DB_FILE="ipinfo_lite.mmdb"
          # The URL uses the IPINFO_TOKEN secret for authentication.
          DOWNLOAD_URL="https://ipinfo.io/data/ipinfo_lite.mmdb?token=${{ secrets.IPINFO_TOKEN }}"
          echo "Downloading MMDB database..."
          curl -L --retry 3 --retry-delay 5 "$DOWNLOAD_URL" -o "$DB_FILE"
          # Check if the downloaded file is not empty to ensure success.
          if [ ! -s "$DB_FILE" ]; then
            echo "Database download failed or file is empty!"
            exit 1
          fi

      # Step 3: Set up the Go environment.
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.26'

      # Step 4: Run the main Go application with -skip-check flag.
      - name: Run Go Application (All IPs)
        env:
          # Pass the downloaded database path to the Go program.
          DB_PATH: ipinfo_lite.mmdb
        run: |
          go mod tidy
          go run . -skip-check

      # Step 5: Checkout the geoip-all branch into a subdirectory.
      - name: Checkout geoip-all branch
        uses: actions/checkout@v6
        with:
          ref: geoip-all
          path: geoip_all_branch

      # Step 6: Sync new data and commit.
      - name: Sync, Commit and Push to geoip-all branch
        run: |
          rsync -av --delete --exclude='.git/' geoip/ geoip_all_branch/
          cd geoip_all_branch

          git config user.name 'wbxBot'
          git config user.email '224158880+wbxbot@users.noreply.github.com'

          git add .
          if git diff --staged --quiet; then
            echo "No changes detected, creating empty commit to maintain daily update schedule"
            git commit --allow-empty -m "ðŸ¤– chore(geoip-all): daily update check - no changes [skip ci]"
          else
            echo "Changes detected, committing updates"
            git commit -m "ðŸ¤– chore(geoip-all): daily update all IP geoip data [skip ci]"
          fi

          git push origin geoip-all
